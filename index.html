<!DOCTYPE HTML>
<html>
<head>
	<title>Agile Board</title>
	<link rel="stylesheet" href="css/bootstrap.min.css">
	<link rel="stylesheet" href="css/bootstrap-theme.min.css">
<style>
div.item {
	border: 1px solid #ddd;
	margin-bottom: 1em;
}
div.container {
	width: 100%;
}
.item {
}
.item .description.expand {
	max-height: 20em;
	overflow-y: auto;
}
.item .description.shrink {
	max-height: 1.5em;
	overflow-y: hidden;
}
textarea[name=description] {
	width: 588px;
	max-width: 588px;
	min-height: 150px;
}
#appmenu {
	max-height: 100px;
	overflow-y: auto;
}
.item .title {
	background-color: #ddd;
	padding-top: 0.2em;
	padding-bottom: 0.1em;
	font-weight: bold;
	font-size: 1.1em;
}
.item .description {
	font-size: 0.8em;
}
.badge.tag {
	background-color: #eee;
	color: #999;
}
ul.pagination {
	margin-top: 0.25em;
	margin-bottom: 0.25em;
}
#globalsearch {
	float: right;
	margin-top: 0.8em;
}
.filter .pagesize {
	padding-left: 0px;
}
.filter .pagesize select {
	padding-left: 0px;
	min-width: 5em;
}
</style>
<script src="js/jquery.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/knockout-3.0.0.js"></script>
</head>
<body id="app">
<div id="appmenu" class="container navbar navbar navbar-fixed-top" role="navigation" style="background-color: #eee; border-bottom: 1px solid black;">
	<div class="container">
		<div class="navbar-header">
			<a class="navbar-brand" href="#">Agile Board</a>
		</div>

		<ul class="nav navbar-nav" data-bind="foreach: logs()">
			<li><a class="btn btn-xs" title="Show/Hide this log" data-bind="click: $parent.toggleBoard, text: title() "></a></li>
		</ul>
		<ul class="nav navbar-nav">
			<li><a class="btn btn-default btn-xs" data-toggle="modal" data-target="#exportimport" data-bind="click: exportData">Import/Export</a></li>
		</ul>

		<div class="col-xs-12 col-sm-3" id="globalsearch">
			<div class="input-group input-group-sm">
				<input type="text" class="form-control " data-bind="value: filterTermInput" placeholder="Filter: title,description,tags,priority,date,site">
				<span data-toggle="tooltip" data-placement="left" title="Click to clear the filter." class="input-group-addon" data-bind="click: function() { filterTermInput('') }">&times;</span>
			</div>
		</div>
	</div>
</div>

<div id="logs" class="container" style="margin-top: 80px;">
	<div data-bind="visible: activeLogs() == 0" >
		<p style="margin-top: 1em;">Click a one of the log names above to toggle of that log.</p>
	</div>
	<div class="row" data-bind="foreach: logs()">
		<div class="" data-bind="visible: visible, css: { 'col-md-2': $parent.activeLogs() > 4, 'col-md-3': $parent.activeLogs() == 4, 'col-md-4': $parent.activeLogs() == 3, 'col-md-6': $parent.activeLogs() == 2, 'col-md-12': $parent.activeLogs() == 1} ">
			<a data-bind="attr: { name: id }"></a>
			<h2>
				<span data-bind="text: title"></span> 
				<button data-bind="visible: id() != 'discarded', click: addItem" title="Add a new item to this log" type="button" class="btn btn-default btn-mini"> <span class="glyphicon glyphicon-plus"></span></button>
			</h2>
			<p data-bind="text: description, visible: items().length == 0 "></p>

			<div class="row filter" style="margin-bottom: 0.5em;" data-bind="visible: items().length > 1">
				<div class="col-xs-10">
					<div class="input-group input-group-xs">
						<input type="text" class="form-control input-sm" data-bind="value: filterTerm" placeholder="Filter: title,description,tags,priority,date,site">
						<span data-toggle="tooltip" title="Click to clear the filter." class="input-group-addon" data-bind="click: function() { filterTerm('') }">&times;</span>
					</div>
				</div>
				<div class="col-xs-2 pagesize">
					<select data-toggle="tooltip" title="Number of items to display" class="form-control input-sm" data-bind="value: pageSize, options: [5,10,15,20]">
					</select>
				</div>
			</div>

			<ul class="pagination" data-bind="visible: totalPages() > 1">
				<li><a id="first" title="First Page" href="#" data-bind="click: function() { currentPage(0); }, css: { disabled: currentPage() === 0 }, visible: totalPages() > 10"><span class="glyphicon glyphicon-fast-backward"></span></a>
				<li><a id="prev" title="Previous Page" href="#" data-bind="click: function (event) { navigate(event) }, css: { disabled: currentPage() === 0 }, visible: totalPages() > 10"><span class="glyphicon glyphicon-backward"></span></a></li>
					<!-- ko foreach: ko.utils.range(1, filteredPages) -->
					<li>
						<a href="#" title="View page" data-bind="click: function() { $parent.currentPage($data-1) }, css: { on: $data === $parent.currentPage()}"><span data-bind="text: $data"></span></a>
					</li>
					<!-- /ko -->
				<li><a id="next" title="Next Page" href="#" data-bind="click: function (event) { navigate(event) }, css: { disabled: currentPage() === totalPages() - 1 }, visible: totalPages() > 10 "><span class="glyphicon glyphicon-forward"></span></a></li>
				<li><a id="last" title="Last Page" href="#" data-bind="click: function() { currentPage(totalPages() - 1); }, css: { disabled: currentPage() === totalPages() - 1 }, visible: totalPages() > 10"><span class="glyphicon glyphicon-fast-forward"></span></a></li>
			</ul>

			<div class="items" data-bind="attr{ 'data-id': id() }, foreach: filteredItems">
				<div class="item">
					<div class="container">
						<div class="row">
							<div class="col-md-12 title" data-bind="text: title">.title</div>
						</div>
						<div class="row">
							<div class="col-xs-6">
								<button type="button" class="btn btn-default btn-xs" title="View Story" data-bind="click: $parent.viewItem"><span class="glyphicon glyphicon-info-sign"></span></button>&nbsp;
								<button type="button" class="btn btn-default btn-xs" title="Edit Story" data-bind="click: $root.editItem"><span class="glyphicon glyphicon-edit"></span></button>&nbsp;
								<!-- <button type="button" class="btn btn-default btn-xs" title="Move to Discarded"><span class="glyphicon glyphicon-trash"></span></button> -->
								<div class="btn-group">
									<button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" title="Move to another log.">
										<span class="glyphicon glyphicon-transfer" title="Move to another log">    
										</span>
									</button>
									<ul class="dropdown-menu" role="menu">
										<li><a href="#" data-moveto="active" data-bind="click: $parent.moveItem">Active</a></li>
										<li><a href="#" data-moveto="horizon" data-bind="click: $parent.moveItem">Horizon</a></li>
										<li><a href="#" data-moveto="valid" data-bind="click: $parent.moveItem">Valid</a></li>
										<li><a href="#" data-moveto="completed" data-bind="click: $parent.moveItem">Completed</a></li>
										<li><a href="#" data-moveto="future" data-bind="click: $parent.moveItem">Future</a></li>
										<!-- <li><a href="#" data-id="discarded" data-bind="click: $parent.moveItem">Discarded</a></li> -->
									</ul>
								</div>&nbsp;
								<button type="button" class="btn btn-default btn-xs" data-bind="click: $root.expand" title="Expand"><span class="glyphicon glyphicon-resize-full"></span></button>&nbsp;
								<button type="button" class="btn btn-default btn-xs" data-bind="click: $root.shrink" title="Collapse"><span class="glyphicon glyphicon-resize-small"></span></button>&nbsp;
								<button type="button" class="btn btn-default btn-xs" data-moveto="discarded" data-bind="click: $parent.moveItem" title="Move to Discarded"><span class="glyphicon glyphicon-trash"></span></button>&nbsp;
							</div>
							<div class="col-xs-3 duedate text-center" data-bind="text: duedate" data-toggle="tooltip" title="Due Date">.duedate</div>
							<div class="col-xs-3 priority text-right">
								<span class="label label-default" data-bind="text: priority, css: { 'label-danger' : priority().toLowerCase() == 'high', 'label-success' : priority().toLowerCase() == 'normal', 'label-info' : priority().toLowerCase() == 'low'}">.priority .badge</span> 
							</div>
						</div>
						<div class="row">
							<div class="col-md-10 col-sm-10 link"><a data-bind="text: link, attr: { 'href': link }">.link a</a></div>
							<!-- <div class="col-md-1">
								<div class="btn-group">
									<button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" title="Related items">
										
										<span class="glyphicon glyphicon-random"></span>
										<span class="caret"></span>
									</button>
									<ul class="dropdown-menu" role="menu">
										<li><a href="#">Title/Priority/duedate</a></li>
									</ul>
								</div>
							</div> -->
							<div class="col-md-12 tags" data-bind="foreach: tags()">
								<span class="badge tag" data-bind="text: $data">.tags .tag</span>
							</div>
							<div class="col-md-12 description shrink"><strong>Description:</strong> <span class="content" data-bind="html: description">Description Content.....</span></div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<hr>

	<footer>
		<p><a href="https://github.com/awoehler/AgileBoard" target="_blank">Agile Board</a></p>
	</footer>
</div>
<div class="templates" style="display: none;">

</div>
<div id="editStory" class="modal fade" role="dialog" tabindex="-1" class="modal fade" aria-labelledby="editStory" aria-hidden="true" data-bind="with: activeItem()">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				<h4 class="modal-title">Edit Story:</h4>
			</div>
			<div class="modal-body">
				<form class="form-horizontal">
					<div class="form-group">
						<input type="text" name="title" class="form-control" placeholder="Title" data-bind="value: title">
					</div>
					<div class="form-group">
						<input type="date" name="duedate" class="form-control" data-bind="value: duedate">
					</div>
					<div class="form-group">
						<input type="text" name="priority" class="form-control" placeholder="Low, Normal, High" data-bind="value: priority">
					</div>
					<div class="form-group">
						<input type="url" name="link" class="form-control" placeholder="http://www.site.com" data-bind="value: link">
					</div>
					<div class="form-group">

						<input type="text" name="tags" class="form-control" placeholder="Example,tags" data-bind="value: tags_input">
					</div>
					<div class="form-group">
						<textarea name="description" class="form-control" placeholder="Description" data-bind="value: description_input"></textarea>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
			</div>
		</div><!-- /.modal-content -->
	</div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div id="deleteStory">
</div>

<div id="exportimport" class="modal fade" role="dialog" tabindex="-1" class="modal fade" aria-labelledby="export" aria-hidden="true" >
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				<h4 class="modal-title">Export</h4>
			</div>
			<div class="modal-body">
				<form class="form-horizontal">
					<p>To export your data copy it from the text area below.</p>
					<div class="form-group">
						<textarea name="data" class="form-control" placeholder="" ></textarea>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal" data-bind="click: importData">Import</button>
				<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
			</div>
		</div><!-- /.modal-content -->
	</div><!-- /.modal-dialog -->
</div><!-- /.modal -->


<script>
tagViewModel = function( v ) {
	var self = this;
	if( typeof v == 'undefined') { v = {}; };
	self.title = ko.observable( typeof v.title == 'string' ? v.title : '' );
}

itemViewModel = function( v ) {
	var self = this;
	if( typeof v == 'undefined') { v = {}; };
	self.id = typeof v.id == "number" ? v.id : 0;
	self.rank = ko.observable( typeof v.rank == "string" ? v.rank : '' );
	self.title = ko.observable( typeof v.title == "string" ? v.title : '' );
	self.duedate = ko.observable( typeof v.duedate == "string" ? v.duedate : '' );
	self.priority = ko.observable( typeof v.priority == "string" ? v.priority : '' );
	self.link = ko.observable( typeof v.link == "string" ? v.link : '' );
	self.description = ko.observable( typeof v.description == "string" ? v.description : '' );
	self.description_input = ko.computed( {
		read: function() {
			return self.description().replace(/<br>/gi,"\n");
		},
		write: function( v ) {
			self.description( v.replace(/\n/g,"<br>") );
		}
	})
	self.tags = ko.observableArray( [] );
	self.expanded = ko.observable( false );

	self.tags_input = ko.computed( {
		read: function() {
			return self.tags().join(',');
		},
		write: function( value) {
			self.tags.removeAll();
			var newtags = value.split(",");
			for( var i=0; i < newtags.length; i++ ) {
				self.tags.push( newtags[i] );
			}
		},
		owner: this
	})

	if( typeof v.tags == 'object' ) {
		for( var i=0; i < v.tags.length; i++ ) {
			self.tags.push( v.tags[ i ] );
		}
	};

};

logViewModel = function( v ) {
	var self = this;
	if( typeof v == 'undefined') { v = {}; };
	self.id = ko.observable( typeof v.id == 'string' ? v.id : '' );
	self.title = ko.observable( typeof v.title == 'string' ? v.title : '' );
	self.description = ko.observable( typeof v.description == 'string' ? v.description : '' );
	self.visible = ko.observable( typeof v.visible == 'boolean' ? v.visible : false );
	self.items = ko.observableArray( [] );
	if( typeof v.items == 'object' ) {
		for( var i=0; i < v.items.length; i++ ) {
			self.items.unshift( new itemViewModel( v.items[ i ] ) );
		}
	}

	self.addItem = function() {
		var ni = new itemViewModel();
		self.items.push( ni );
		app.editItem( ni );

	}

	self.moveItem = function( e, d ) {
		var moveto = $(d.currentTarget).data("moveto");
		self.items.remove( e );
		if( "discarded" != self.id() || self.id() != moveto ) {
			app[ moveto ]().items.push( e );
		}
		app.save();
	}

	self.filterTerm = ko.observable("");
	self.filteredPages = ko.observable(0);

	self.currentPage = ko.observable(0);
	self.pageSize = ko.observable(5);
	self.navigate = function (e) {
		var el = e.target;
		if (el.id === "next") {
			if (this.currentPage() < ko.utils.unwrapObservable(this.totalPages()) - 1) {
				this.currentPage(this.currentPage() + 1);
			}
		} else {
			if (this.currentPage() > 0) {
				this.currentPage(this.currentPage() - 1);
			}
		}
	}

	self.totalPages = ko.computed(function () {
		return Math.ceil(ko.utils.unwrapObservable(self.items).length / self.pageSize());
	});
 
	self.showCurrentPage = ko.computed(function () {
		if (self.currentPage() > Math.ceil(ko.utils.unwrapObservable(self.items).length / self.pageSize())) {
			self.currentPage(ko.utils.unwrapObservable(this.totalPages()) - 1);
		}
		var startIndex = self.pageSize() * self.currentPage();
		return self.items.slice(startIndex, startIndex + self.pageSize());
	});
 
	self.numericPageSize = ko.computed(function () {
		if (typeof (self.pageSize()) !== "number") {
			self.pageSize(parseInt(this.pageSize()));
		}
	});

	self.filteredItems = ko.computed(function() {
		var all = self.items(), rv = [];
		for (var i = 0; i < all.length; i++) {
			var terms = this.filterTerm().toLowerCase().split(",");
			for( var j=0; j < terms.length; j++ ) {
				if (all[i].title().toLowerCase().indexOf( terms[j] ) > -1 ||
					all[i].description().toLowerCase().indexOf( terms[j] ) > -1 ||
					all[i].duedate().indexOf( terms[j] ) > -1 ||
					all[i].priority().toLowerCase().indexOf( terms[j] ) > -1 ||
					all[i].link().toLowerCase().indexOf( terms[j] ) > -1 ||	
					all[i].tags().join().toLowerCase().indexOf( terms[j] ) > -1
					) {
					rv.push(all[i]);
				}
			}
		}
		self.filteredPages( Math.ceil( rv.length / self.pageSize() ) );
		return rv.slice( self.currentPage() * self.pageSize() ,(self.pageSize() * self.currentPage() )+self.pageSize() );
	}, this);
};

appViewModel = function( v ) {
	var self = this;
	if( typeof v == 'undefined') { v = {}; };
	
	self.filterTerm = ko.observable('');
	self.filterTermInput = ko.computed({
		read: function() {
			return self.filterTerm();
		},
		write: function( v ) {
			var logs = app.logs();
			for( var i=0; i < logs.length; i++ ) {
				logs[i]().filterTerm( v );
			}
		}
	});
	self.activeItem = ko.observable( new itemViewModel() );
	self.active = ko.observable( new logViewModel( typeof v.active == 'object' ? v.active : undefined ) );
	self.horizon = ko.observable( new logViewModel( typeof v.horizon == 'object' ? v.horizon: undefined ) );
	self.future = ko.observable( new logViewModel(typeof v.future == 'object' ? v.future : undefined ) );
	self.completed = ko.observable( new logViewModel( typeof v.completed == 'object' ? v.completed : undefined ) );
	self.discarded = ko.observable( new logViewModel( typeof v.discarded == 'object' ? v.discarded : undefined ) );
	self.valid = ko.observable( new logViewModel( typeof v.valid == 'object' ? v.valid : {} ) );

	self.logs = ko.observableArray([ self.future, self.horizon, self.active, self.valid, self.completed, self.discarded, ] );

	self.activeLogs = ko.computed( function() {
		var i=0; 
		i += self.active().visible() ? 1 : 0;
		i += self.horizon().visible() ? 1 : 0;
		i += self.future().visible() ? 1 : 0;
		i += self.discarded().visible() ? 1 : 0;
		i += self.completed().visible() ? 1 : 0;
		i += self.valid().visible() ? 1 : 0;
		return i;
	});

	self.toggleBoard = function( e, d ) {
		e.visible( e.visible() ? false : true );
		self.save();
		e.visible() ? location.hash = e.id() : '';
	}

	self.save = function() {
		localStorage.setItem('agileboard', ko.toJSON( self ) );
	}

	self.load = function() {
		try {
			var d = localStorage.getItem('agileboard');
			if( d == null ) return;
			var v = JSON.parse( d );
			self.active( new logViewModel( typeof v.active == 'object' ? v.active : undefined ) );
			self.horizon( new logViewModel( typeof v.horizon == 'object' ? v.horizon: undefined ) );
			self.future( new logViewModel( typeof v.future == 'object' ? v.future : undefined ) );
			self.completed( new logViewModel( typeof v.completed == 'object' ? v.completed : undefined ) );
			self.discarded( new logViewModel( typeof v.discarded == 'object' ? v.discarded : undefined ) );
			self.valid( new logViewModel( typeof v.valid == 'object' ? v.valid : undefined ) );
		} catch( e ) {
			alert('An error occured while trying to import the data. ' + e );
		}
	}

	self.exportData = function() {
		$("#exportimport textarea[name=data]").val( localStorage.getItem('agileboard') );
	}
	self.importData = function() {
		localStorage.setItem('agileboard', $("#exportimport textarea[name=data]").val() );
		self.load();
	}

	self.editItem = function( e, d ) {
		self.activeItem( e );
		$("#editStory").modal();
	}

	self.viewItem = function( e ) {
	}

	self.removeTag = function( n ) {

	};

	self.expand = function( a, b ) {
		$( b.currentTarget ).closest(".item").find(".description").addClass("expand").removeClass("shrink");
	};

	self.shrink = function( a, b ) {
		$( b.currentTarget ).closest(".item").find(".description").addClass("shrink").removeClass("expand");
	}
};

config = {
	"future": {
		"id":"future",
		"title": "Future",
		"description": "Tasks that will need to be done in the future but not the immediate future.",
		"visible": false
	},
	"horizon": {
		"id":"horizon",
		"title": "Horizon",
		"description": "Task that will be started in the near future.",
		"visible": true
	},
	"active": {
		"id":"active",
		"title": "Active",
		"description": "Tasks that are currently being worked on.",
		"visible": true	
	},
	"valid": {
		"id":"valid",
		"title": "Valid",
		"description": "Completed tasks that the customer needs to verify.",
		"visible": true
	},
	"completed": {
		"id":"completed",
		"title": "Completed",
		"description": "Tasks that have been completed and verified.",
		"visible": false
	},
	"discarded": {
		"id":"discarded",
		"title": "Discarded",
		"description": "Tasks that have been discarded but not yet deleted.",
		"visible": false
	}
}

$(document).ready( function() {
	app = new appViewModel( config );
	//Sample item
	// app.horizon().items.push( new itemViewModel() )
	// app.future().items.push( new itemViewModel() )
	// app.discarded().items.push( new itemViewModel() )
	// app.active().items.push( new itemViewModel() )
	// app.valid().items.push( new itemViewModel() )
	// app.completed().items.push( new itemViewModel() )

	ko.applyBindings( app );
	app.load();
	$("[title]").tooltip();
	//Adjust the top of the logs so that the menu does not cover it up.
	$("#logs").css("margin-top", $("#appmenu").height() );
	$('#editStory').on('hide.bs.modal', app.save );
});
</script>
</body></html>